<?php
declare(strict_types = 1);

namespace FetchMetadata;

use Random\Randomizer;

require_once __DIR__ . '/functions.php';
require_once __DIR__ . '/../functions.php';
?>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Fetch Metadata (Sec-Fetch-Dest etc.) Demo</title>
	<meta name="description" content="Fetch Metadata (Sec-Fetch-Dest etc.) demo page where you can see what Sec-Fetch-* headers your browser sends and when.">
	<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Fetch Metadata request headers</h1>
<p>
	<strong>Fetch Metadata</strong> is a set of several HTTP request headers that provide additional context to the server
	about what the browser is going to do with the response, where the request has originated, and whether the request was user-activated.
	Based on these headers, the server may for example implement extra access control and similar.
</p>
<p>
	This is a live demo page, it displays exactly the headers your browser has sent.
	Speaking of which, your browser has sent the following <strong>Fetch Metadata</strong> headers for various request types:
</p>
<h2><code>Sec-Fetch-*</code> request headers for this page</h2>
<p class="headers">
<?= headerHtml('Sec-Fetch-Dest'); ?><br>
<?= headerHtml('Sec-Fetch-Mode'); ?><br>
<?= headerHtml('Sec-Fetch-Site'); ?><br>
<?= headerHtml('Sec-Fetch-User'); ?><br>
</p>

<h2><code>Sec-Fetch-*</code> request headers for an iframe</h2>
<iframe src="iframe.php" id="iframe" title="Sec-Fetch-* request headers for an iframe"></iframe><br>
Reload the iframe
<button id="reloadIframe">now</button>
<button class="intervalFrame" data-after="4">after 4 secs</button>
<button class="intervalFrame" data-after="5">after 5 secs</button>
<p><em>
	Reloading the iframe is user-activated if it happens immediately or in less than 5 seconds,<br>
	click the buttons and watch the <code>Sec-Fetch-User</code> header.
</em></p>

<h2><code>Sec-Fetch-*</code> request headers for a <code>&lt;script&gt;</code> tag</h2>
<p class="headers">
<code>Sec-Fetch-Dest</code>: <code id="destScript">&hellip;</code><em id="destScriptNote">&hellip;</em><br>
<code>Sec-Fetch-Mode</code>: <code id="modeScript">&hellip;</code><em id="modeScriptNote">&hellip;</em><br>
<code>Sec-Fetch-Site</code>: <code id="siteScript">&hellip;</code><em id="siteScriptNote">&hellip;</em><br>
<code>Sec-Fetch-User</code>: <code id="userScript">&hellip;</code><em id="userScriptNote">&hellip;</em><br>
</p>
<script src="script.php"></script>
<p>Headers sent when downloading a script with a <code>&lt;script src="&hellip;"&gt;&lt;/script&gt;</code> tag</p>

<h2><code>Sec-Fetch-*</code> request headers for an <code>&lt;img&gt;</code> tag</h2>
<img src="image.php" width="300" height="105" alt="Fetch metadata request headers for an image" id="image"></script><br>
<button id="reloadImage">Reload the image</button>
or <button id="openImage">Open the image</button></>
<p><em>
	For some reason, reloading the image is not user-activated and will not send <code>Sec-Fetch-User</code>.
	Opening the image in a new tab will send different headers, notably the <code>Sec-Fetch-Dest</code> header will be <code>document</code>.
</em></p>

<h2><code>Sec-Fetch-*</code> request headers for <code>fetch()</code></h2>
<p class="headers">
<code>Sec-Fetch-Dest</code>: <code id="destFetch">&hellip;</code><em id="destFetchNote">&hellip;</em><br>
<code>Sec-Fetch-Mode</code>: <code id="modeFetch">&hellip;</code><em id="modeFetchNote">&hellip;</em><br>
<code>Sec-Fetch-Site</code>: <code id="siteFetch">&hellip;</code><em id="siteFetchNote">&hellip;</em><br>
<code>Sec-Fetch-User</code>: <code id="userFetch">&hellip;</code><em id="userFetchNote">&hellip;</em><br>
<small><em>(Generated at <span id="atFetch">&hellip;</span>)</em></small>
</p>
<p><button id="fetchAgain">Fetch again</button></p>
<p><em>
	Fetching again will not set <code>Sec-Fetch-User</code> even when the <code>fetch()</code> was clearly triggered by you.
	This is because the header is delivered only for <a href="https://fetch.spec.whatwg.org/#navigation-request">navigation requests</a>
	whose destination in <code>Sec-Fetch-Dest</code> is <code>document</code>, <code>embed</code>, <code>frame</code>, <code>iframe</code>, or <code>object</code>,
	and this wasn't one.
</em></p>

<?= \Exploited\footerWithSourceLink('https://github.com/spaze/exploited.cz/tree/main/site/fetch-metadata'); ?>

<script>
document.querySelectorAll(".intervalFrame").forEach(function (item) {
	item.addEventListener("click", (event) => {
		const element = event.target;
		element.dataset.origText = element.innerText;
		element.innerText = element.dataset.after;
		element.disabled = true;
		const id = setInterval(() => {element.innerText = element.innerText - 1}, 1000);
		setTimeout(() => {
			clearInterval(id);
			document.getElementById("iframe").contentWindow.location.reload();
			element.disabled = false;
			element.innerText = element.dataset.origText;
		}, element.dataset.after * 1000);
	});
});
document.getElementById("reloadIframe").addEventListener("click", () => {
	document.getElementById("iframe").contentWindow.location.reload();
});
document.getElementById("reloadImage").addEventListener("click", () => {
	const image = document.getElementById("image");
	const url = new URL(image.src, location);
	url.searchParams.set('r', Math.random());
	image.src = url;
});
document.getElementById("openImage").addEventListener("click", function() {
	document.location = "image.php?r=<?= (new Randomizer())->getFloat(0, 1); ?>";
});
const fetchHeaders = function() {
	fetch("fetch.php")
		.then((response) => {
			return response.json();
		})
		.then((json) => {
			document.getElementById('destFetch').innerText = json.dest.value;
			document.getElementById('destFetchNote').innerText = json.dest.note;
			document.getElementById('modeFetch').innerText = json.mode.value;
			document.getElementById('modeFetchNote').innerText = json.mode.note;
			document.getElementById('siteFetch').innerText = json.site.value;
			document.getElementById('siteFetchNote').innerText = json.site.note;
			document.getElementById('userFetch').innerText = json.user.value;
			document.getElementById('userFetchNote').innerText = json.user.note;
			document.getElementById('atFetch').innerText = json.at;
		});
};
fetchHeaders();
document.getElementById("fetchAgain").addEventListener("click", fetchHeaders);
</script>
</body>
</html>
