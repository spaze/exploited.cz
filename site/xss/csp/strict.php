<?php
$nonce = $_GET['nonce'] ?? base64_encode(random_bytes(16));
$valid = preg_match('~^[a-zA-Z0-9+/=]+$~', $nonce);
$compat = ($_GET['compat'] ?? 'yes') === 'yes';
$header = "script-src 'strict-dynamic' 'nonce-{$nonce}'" . ($compat ? " 'unsafe-inline' http: https:" : '') . "; object-src 'none'; base-uri 'none'";
header("Content-Security-Policy: {$header}");
$inserted = $_GET['inserted'] ?? null;
$attr = 'nonce="' . htmlspecialchars($nonce) . '"';
$jquery = 'https://code.jquery.com/jquery-3.7.1.min.js'; // Update in color.js as well

require_once __DIR__ . '/../../functions.php';
?>
<!DOCTYPE html>
<html lang="en">
<head>
<title>CSP3 strict-dynamic</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Content Security Policy Level 3 (CSP3) demo app showcasing using the strict CSP setting with the strict-dynamic value which makes CSP deployments easier.">
<style>
	body { max-width: 1080px; margin: 1em auto; padding: 1em; line-height: 1.5; font-family: sans-serif; }
	a { color: #8457DE; }
	code { color: #06C; font-size: larger; }
	code span { color: #070; }
	.code { padding: 0.5em; background-color: #EEE; line-height: 1em; }
	.warn { padding: 0.5em; color: #F00; background-color: #FDD; }
	.highlight { color: #00F; background-color: #DDF; }
	#color { text-decoration: underline; cursor: pointer; }
	@media (prefers-color-scheme: dark) {
		body { color: #EEE; background-color: #333; }
		a { color: #99D; }
		code { color: #0AF; }
		code span { color: #0B0; }
		.code { padding: 0.5em; background-color: #2A2A2F; line-height: 1em; }
		.warn { padding: 0.5em; color: #FDD; background-color: #992E2E; }
		.highlight { color: #DDF; background-color: #66F; }
	}
</style>
<?php if ($inserted === 'parser') { ?>
	<script <?= $attr ?>>document.write('<script src="<?= $jquery ?>" async defer><\/script>');</script>
<?php } else { ?>
	<script <?= $attr ?> src="color.js" async defer></script>
<?php } ?>
</head>
<body>
<h1>Content Security Policy Level 3 <code>'strict-dynamic'</code></h1>
<p>&hellip;makes CSP deployments easier. This demo page will show you why and how.</p>
<h2>The server has sent this header to your browser</h2>
<p><strong><code>Content-Security-Policy:<br><span><?= htmlspecialchars($header) ?></span></code></strong></p>

<?php if (!$valid) { ?>
	<p class="warn"><strong><em>Invalid nonce value <code><?= htmlspecialchars($nonce) ?></code>, it needs to be a Base64-value, check console</em></strong> (<a href="strict.php">Use random Base64-value nonce</a>)</p>
<?php } ?>

<h2>The <code>script-src</code> values</h2>
<dl>
	<dt><code>'strict-dynamic'</code></dt>
	<dd>Allows script which executes on a page to load more scripts via non-"HTML-parser-inserted" <em>script</em> elements using <code>document.createElement('script');</code> or similar (CSP3 and above)</dd>

	<dt><code>'nonce-<span><?= htmlspecialchars($nonce) ?></span>'</code></dt>
	<dd>Scripts with <code>nonce="<span><?= htmlspecialchars($nonce) ?></span>"</code> can be fetched and executed (CSP2 and above)</dd>

	<dt><code>'unsafe-inline'</code></dt>
	<dd><em>unsafe-inline</em> is ignored if a <em>nonce</em> or a <em>hash</em> is present (CSP2 and above)</dd>
	<dd>Because of <em>strict-dynamic</em> this entry is ignored (CSP3 and above)</dd>

	<dt><code>http:</code></dt>
	<dd>Because of <em>strict-dynamic</em> this entry is ignored (CSP3 and above)</dd>

	<dt><code>https:</code></dt>
	<dd>Because of <em>strict-dynamic</em> this entry is ignored (CSP3 and above)</dd>
</dl>

<h2>The <code>object-src</code> values</h2>
<dl>
	<dt><code>'none'</code></dt>
	<dd>Don't allow embedding Flash content, potentially with XSS vulnerabilities</dd>
</dl>

<h2>The <code>base-uri</code> values</h2>
<dl>
	<dt><code>'none'</code></dt>
	<dd>Prevents injection of <code>base</code> tags, which can be used to set the base URL for relative script URLs to an evil domain</dd>
</dl>

<h2>Demo</h2>
<div id="color"><em>Click to change color</em></div>
<?php if ($inserted === 'parser') { ?>
	<p class="warn"><strong><em>Parser-inserted <code>script</code> element, will not work in browsers supporting <code>'strict-dynamic'</code>, check console</em></strong> (<a href="strict.php">Switch to non-parser-inserted</a>)</p>
<?php } ?>
<script <?= $attr ?>>document.getElementById('color').onclick = function(){alert('jQuery not loaded yet');};</script>

<h3>In a browser with CSP Level 3 support <small>(<a href="https://www.chromestatus.com/feature/5633814718054400">Chrome 52+</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1299483">Firefox 52+</a>, <a href="https://webkit.org/blog/12445/new-webkit-features-in-safari-15-4/#security">Safari 15.4+</a>)</small></h3>
<ol>
	<li>The <a href="color.js"><em>color.js</em></a> script was loaded using <code>&lt;script nonce="<span><?= htmlspecialchars($nonce) ?></span>" src="color.js"&gt;</code></li>
	<li><em>color.js</em> is allowed to load jQuery from <em><?= $jquery ?></em> using <code>document.createElement('script');</code> because of <em>strict-dynamic</em></li>
	<li>jQuery "click" handler is attached</li>
</ol>
<?php if ($compat) { ?>
<h3>In a browser with CSP Level 2 support</h3>
<ol>
	<li>The <a href="color.js"><em>color.js</em></a> script was loaded using <code>&lt;script nonce="<span><?= htmlspecialchars($nonce) ?></span>" src="color.js"&gt;</code></li>
	<li><em>color.js</em> is allowed to load jQuery from <em><?= $jquery ?></em> because of <em>https:</em></li>
	<li>jQuery "click" handler is attached</li>
</ol>
<h3>In a browser with CSP Level 1 support</h3>
<ol>
	<li>The <a href="color.js"><em>color.js</em></a> script was loaded using <code>&lt;script src="color.js"&gt;</code> because of <em>https:</em>, <em>nonce</em> was ignored</li>
	<li><em>color.js</em> is allowed to load jQuery from <em><?= $jquery ?></em> because of <em>https:</em></li>
	<li>jQuery "click" handler is attached</li>
</ol>
<p><a href="?compat=no">Disable backward compatibility</a></em></strong></p>
<?php } else { ?>
<p class="warn"><strong><em>CSP Level 2 & Level 1 backward compatibility disabled, <a href="strict.php">enable</a></em></strong></p>
<?php } ?>

<h2>Parser-inserted?</h2>
<p><code>'strict-dynamic'</code> doesn't allow executed script to load more scripts via "HTML-parser-inserted" <em>script</em> elements (regular <code>&lt;script&gt;</code> tags). That means that the following script or similar will <strong>not</strong> work. (<a href="?inserted=parser">Try it anyway</a>)</p>
<div class="code">
<code>&lt;script <span><?= $attr ?></span>&gt;<br>
document.write('&lt;script src="<?= $jquery ?>" async defer&gt;&lt;\/script&gt;');<br>
&lt;/script&gt;</code>
</div>

<h2>Nonce format</h2>
<p><em>Nonce</em> needs to be a Base64-value, otherwise browsers will ignore it. <a href="?nonce=foo*bar">Try non-Base64-value</a> and check console.</p>

<p>Check also <a href="https://exploited.cz/xss/csp.php">general <em>host-based</em> CSP demo page</a> and <a href="https://canhas.report">reporting demo app</a>.</p>

<?= \Exploited\footerWithSourceLink('https://github.com/spaze/exploited.cz/tree/main/site/xss/csp'); ?>
</body>
</html>
